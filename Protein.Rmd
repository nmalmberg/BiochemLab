---
title: "Protein Purification Functions"
author: "Nathan Malmberg"
date: "10/15/2018"
output: 
  bookdown::html_document2:
    number_sections: FALSE
bibliography: [knitr.bib, references.bib]
csl: american-chemical-society.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Absorbance Data

Use the following code block to record the absorbance of the fractions from the size exclusion columns. Keep track of which column as well as the fraction number and absorbance.

```{r absorbancedata}
absorbance <- read.table("absorbance.dat", header=TRUE)
```

If you perform a Bradford assay on your fractions, you can use the following
code block to read the files generated by the plate reader. Correctly
associating the well with the fraction will require that you add the protein
to the wells by column rather than by row. You'll need to
save the FC folder in your project folder.

```{r bradford}
absorbance <- data.frame()
# replate <- list()
for (filename in list.files("FC", full.names = TRUE)){
  plate <- read.table(filename, skip=7)
  replate <- reshape(plate, direction="long", varying = 1:12,
                              ids=row.names(plate), idvar = "Row", sep="",
                              timevar = "Column", v.names = "Absorbance")
  replate$Run <- basename(filename)
  replate$Fraction <- seq_along(replate$Absorbance)
  absorbance <- rbind(absorbance, replate)
}
absorbance <- subset(absorbance, Fraction <= 80)
absorbance$Run <- factor(absorbance$Run)
```

You can then plot the data with the following block, adding lines and adjusting the position of the legend as necessary.

(ref:absorbance) Provide an appropriate figure caption for your absorbance plot here. Where did this data come from? What do the different axes represent?

```{r absorbanceplot, fig.cap="(ref:absorbance)"}
plot(Absorbance~Fraction, data=absorbance, type="n",
     xlab="Fraction number",
     ylab = expression(A[280]))
for (run in 1:length(levels(absorbance$Run))) {
  lines(Absorbance ~ Fraction,data = absorbance,lty = run,
        subset = (Run == levels(absorbance$Run)[run]))
}
legend("topleft",legend=levels(absorbance$Run),lty=1:length(levels(absorbance$Run)))
```

## Gel Data

To include an image of your gel, use a code block like the one in Figure \@ref(fig:gelimage). Make sure the gel image has been saved in the same folder as your Markdown document.

(ref:gel) Describe your gel in this figure legend. What is in each lane of the gel? What kind of gel is it?

```{r gelimage, fig.cap="(ref:gel)"}
knitr::include_graphics("nameoffile.jpg", dpi=NA)
```

The gel imager can measure the migration distance of gel bands relative to each other. The CSV file that the imager software outputs is not very well-behaved, but we can use R to extract the necessary information from the file and add the appropriate molecular weights to the standard file.

```{r mwdet}
csvlines <- readLines("GelFile.csv")
# We need to select the lines between "Bands:" and "Concentration:"
bands <- grep("Bands:", csvlines, fixed=TRUE, value=FALSE) + 2
conc <- grep("^Concentration:", csvlines, fixed=FALSE,
             value=FALSE) - 3
geldata <- read.delim(header=TRUE, row.names = 2,
                      text=paste(csvlines[bands:conc],
                                 collapse="\n"))
# Replace the MW column with NA for most of the bands, and with
# the appropriate MW for the ladder bands.
geldata$MW <- NA
geldata["A3", "MW"] <- 170 # Etc.

# Fit the data to a straight line, with a logarithmic scaling
# of the MW data.
mwmodel <- glm(MW~Rf, data=geldata, family=gaussian(link=log))

# Use the model to predict the molecular weights of the bands
# from other lanes. Include standard errors of the weights.
predict(mwmodel, newdata=subset(geldata, Lane.ID!="A"),
        type="response", se.fit=TRUE)
```

The plot below will show how the ladder data fits to the model. This is not necessary for the calculation, but it can be reassuring to see that the data fits.
Note that the output of the code block below will not be shown in the final document. This can be changed, but only do so if you intend to draw conclusions from the plot, and then make sure to give the plot an appropriate caption.

```{r eval=FALSE, echo=FALSE}
plot(log(MW)~Rf, data=geldata)
abline(mwmodel)
```

Your lab report should include a bibliography, of course.

```{r bibliography, include=FALSE}
knitr::write_bib("base", "knitr.bib")
```

## References
